---
title: "W241_Project_PGSS_Campaign"
author: "Subha Vadakkumkoor, Walter Burge"
date: "August 3, 2018"
output: pdf_document
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)
```


## Loading data

Data imported from Salsa, excluding PII fields (name and email address) are read into R dataframes. All dataframes have the same structure and format. With each step of the treatment (Orignal email, Reminder1 and Reminder2), there are 2 files: list of people that were assigned the treatment (recieved the email) and list of people that responded to the treatment (donated money).

```{r pressure, echo=TRUE}
library(data.table)
library(stargazer)
library(dplyr)
library(readr)
```

```{r}

#Load data

#Original email
orig_email_rec<-read.csv('./data/BlastReport_Class Experiment Final Email_Recipients.csv')
setnames(orig_email_rec, old=c("Opened"), new=c("pened_orig_email"))

orig_email_resp<-read.csv('./data/BlastReport_Class Experiment Final Email_Conversions.csv')
#Create an indicator and rename columns to reflect original email response (useful for merge later)
orig_email_resp$donated_after_orig_email=1
names(orig_email_resp)
setnames(orig_email_resp, old=c("Conversion.Date","Amount"), new=c("Orig_email_conversion_date", "orig_email_amount"))

#Reminder1
reminder1_rec<-read.csv('./data/BlastReport_Class experiment Reminder1_Recipients.csv')
setnames(reminder1_rec, old=c("Opened"), new=c("opened_reminder1"))


reminder1_resp<-read.csv('./data/BlastReport_Class experiment Reminder1_Conversions.csv')
reminder1_resp$donated_after_reminder1=1
setnames(reminder1_resp, old=c("Conversion.Date","Amount"), new=c("reminder1_conversion_date", "reminder1_amount"))

#Reminder2
reminder2_rec<-read.csv('./data/BlastReport_Class Experiment Reminder 2_Recipients.csv')
setnames(reminder2_rec, old=c("Opened"), new=c("opened_reminder2"))

reminder2_resp<-read.csv('./data/BlastReport_Class Experiment Reminder 2_Conversions.csv')
reminder2_resp$donated_after_reminder2=1
setnames(reminder2_resp, old=c("Conversion.Date","Amount"), new=c("reminder2_conversion_date", "reminder2_amount"))


#Examine the layout of a representative file
cat("Fields in recipients file\n")
names(orig_email_rec)

cat("\nFields in responder files\n")
names(orig_email_resp)

#Get dimensions of each file
cat("\nDimensions of each file\n")
dfList <- list(orig_email_rec,orig_email_resp,reminder1_rec,reminder1_resp,reminder2_rec,reminder2_resp)
lapply(dfList,dim)

```
Now we merge the orignal rec and resp datasets with the responders from reminder1 and reminder2. We assume that the reminders were sent to same people that original emails were sent to. Some of the fields like "opened", etc of reminders are not captured as they may not be required just yet and can be added later if needed.  

```{r}
#Merge with the original email response
merged<-merge(orig_email_rec,orig_email_resp[,c("Supporter.ID","Orig_email_conversion_date","orig_email_amount","donated_after_orig_email")],by="Supporter.ID",all.x=TRUE)

cat("\nNum of rows",nrow(merged))

#Merge with the first reminder response
merged<-merge(merged,reminder1_resp[,c("Supporter.ID","reminder1_conversion_date","reminder1_amount","donated_after_reminder1")],by="Supporter.ID",all.x=TRUE)

cat("\nNum of rows",nrow(merged))

#Merge with the second reminder response
merged<-merge(merged,reminder2_resp[,c("Supporter.ID","reminder2_conversion_date","reminder2_amount","donated_after_reminder2")],by="Supporter.ID",all.x=TRUE)

cat("\nNum of rows",nrow(merged))

merged[(is.na(merged$donated_after_orig_email)),]$donated_after_orig_email=0
merged[(is.na(merged$donated_after_reminder1)),]$donated_after_reminder1=0
merged[(is.na(merged$donated_after_reminder2)),]$donated_after_reminder2=0
        

#Total donation amount
merged$total_donation_amount=merged$orig_email_amount+merged$reminder1_amount+merged$reminder2_amount
#CHECK FOR MULTIPLE DONATIONS

#Create time of donation indicator - when did they donate

#Need to add more indicators : read both original and reminder and responded only after reminder, etc

#Define non-compliance. What about people who opened but did not click or contribute?

table(merged$donation_status)

#Define treatment indicator
merged$treat<-ifelse(merged$Split.Name %in% c("Split A"),1,0)
table(merged$Split.Name,merged$treat)

```

Initial regression trial

```{r}

cat("Response rate after original email")
table(merged$donated_after_orig_email,merged$treat)


cat("Response rate after reminder1")
table(merged$donated_after_reminder1,merged$treat)


cat("Response rate after reminder2")
table(merged$donated_after_reminder2,merged$treat)


#ADD DAYS SINCE DONATION

```

Initial regression trial

```{r}

reg1<-lm(donated_after_orig_email~treat, data=merged)
print(summary(reg1))

#Add other regressions here

```